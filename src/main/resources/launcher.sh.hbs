#!/usr/bin/env sh

set -eu

# Launcher for {{{artifactName}}}
# Generated by execjar (https://github.com/parttimenerd/execjar)

# Embedded configuration
MIN_JAVA_VERSION={{{minJavaVersion}}}
{{#if maxJavaVersion}}
MAX_JAVA_VERSION={{{maxJavaVersion}}}
{{else}}
MAX_JAVA_VERSION=""
{{/if}}
{{#if strictMode}}
STRICT_MODE=1
{{else}}
STRICT_MODE=0
{{/if}}

# Set custom environment variables
{{#if hasEnvironmentVariables}}
{{#each environmentVariables}}
export {{{@key}}}="{{{this}}}"
{{/each}}
{{/if}}

# Debug mode
DEBUG="${EXECJAR_DEBUG:-0}"

debug() {
    if [ "$DEBUG" = "1" ]; then
        echo "[DEBUG] $*" >&2
    fi
}

# Process JVM options that start with -D, -X, -agent, or -J
USER_JAVA_OPTS=""
while [ $# -gt 0 ]; do
    case "$1" in
        -D*|-X*)
            if [ ${#1} -gt 2 ]; then
                USER_JAVA_OPTS="$USER_JAVA_OPTS $1"
                shift
            else
                shift
            fi
            ;;
        -agent*)
            USER_JAVA_OPTS="$USER_JAVA_OPTS $1"
            shift
            ;;
        -J*)
            opt=$(echo "$1" | cut -c3-)
            USER_JAVA_OPTS="$USER_JAVA_OPTS $opt"
            shift
            ;;
        *)
            # First non-JVM option stops parsing
            break
            ;;
    esac
done



# Function to extract Java major version
get_java_version() {
    java_exe="$1"
    if [ ! -x "$java_exe" ]; then
        echo "0"
        return
    fi

    # Try to read version from release file first (much faster than java -version)
    # The release file is typically at $JAVA_HOME/release or ../release relative to bin/java
    java_dir=$(dirname "$java_exe")
    java_home=$(dirname "$java_dir")
    release_file="$java_home/release"

    if [ -f "$release_file" ]; then
        debug "Found release file: $release_file"

        # Extract JAVA_VERSION from release file
        # Format: JAVA_VERSION="17" or JAVA_VERSION="17.0.1"
        version=$(grep '^JAVA_VERSION=' "$release_file" 2>/dev/null | sed 's/^JAVA_VERSION="//' | sed 's/"$//')

        if [ -n "$version" ]; then
            debug "Version from release file: $version"

            # Extract major version from JAVA_VERSION
            major=$(echo "$version" | sed -n 's/^1\.\([0-9]*\).*/\1/p')
            if [ -n "$major" ]; then
                # Old format (1.8.0_xxx -> 8)
                echo "$major"
                return
            fi

            # New format (11.0.x -> 11 or just 17 -> 17)
            major=$(echo "$version" | sed -n 's/^\([0-9]*\).*/\1/p')
            if [ -n "$major" ]; then
                echo "$major"
                return
            fi
        fi
    fi

    # Fallback to java -version (slower)
    debug "No release file found or could not parse, falling back to java -version"
    version_output=$("$java_exe" -version 2>&1)


    # Extract version number
    # Handles both old format (1.8.0_xxx) and new format (11.0.x, 17.0.x, etc.)
    version=$(echo "$version_output" | head -n 1 | sed -n 's/.*version "\(.*\)".*/\1/p')

    if [ -z "$version" ]; then
        echo "0"
        return
    fi

    # Extract major version
    major=$(echo "$version" | sed -n 's/^1\.\([0-9]*\).*/\1/p')
    if [ -n "$major" ]; then
        # Old format (1.8.0_xxx -> 8)
        echo "$major"
        return
    fi

    # New format (11.0.x -> 11)
    major=$(echo "$version" | sed -n 's/^\([0-9]*\).*/\1/p')
    if [ -n "$major" ]; then
        echo "$major"
    else
        echo "0"
    fi
}

# Function to check if Java version is valid
is_valid_version() {
    version="$1"

    if [ "$version" = "0" ] || [ -z "$version" ]; then
        return 1
    fi

    if [ "$version" -lt "$MIN_JAVA_VERSION" ]; then
        debug "Version $version is below minimum $MIN_JAVA_VERSION"
        return 1
    fi

    if [ -n "$MAX_JAVA_VERSION" ] && [ "$version" -gt "$MAX_JAVA_VERSION" ]; then
        debug "Version $version is above maximum $MAX_JAVA_VERSION"
        return 1
    fi

    return 0
}

# Find best Java executable
BEST_JAVA=""
BEST_VERSION=0

# Strict mode: check if 'java' in PATH exists and is valid
if [ "$STRICT_MODE" = "1" ]; then
    if ! command -v java >/dev/null 2>&1; then
        echo "Error: Strict mode enabled - 'java' not found in PATH for {{{artifactName}}}" >&2
        echo "" >&2
        echo "Requirements:" >&2
        echo "  - 'java' must be available in PATH" >&2
        echo "  - Java version >= $MIN_JAVA_VERSION" >&2
        if [ -n "$MAX_JAVA_VERSION" ]; then
            echo "  - Java version <= $MAX_JAVA_VERSION" >&2
        fi
        echo "" >&2
        echo "Please ensure a compatible 'java' is in your PATH." >&2
        exit 1
    fi

    PATH_JAVA="$(command -v java)"
    PATH_VERSION=$(get_java_version "$PATH_JAVA")

    if ! is_valid_version "$PATH_VERSION"; then
        echo "Error: Strict mode enabled - 'java' in PATH is not compatible for {{{artifactName}}}" >&2
        echo "" >&2
        echo "Found: $PATH_JAVA (version $PATH_VERSION)" >&2
        echo "" >&2
        echo "Requirements:" >&2
        echo "  - Java version >= $MIN_JAVA_VERSION" >&2
        if [ -n "$MAX_JAVA_VERSION" ]; then
            echo "  - Java version <= $MAX_JAVA_VERSION" >&2
        fi
        echo "" >&2
        echo "Please update your PATH to point to a compatible Java installation." >&2
        exit 1
    fi

    # In strict mode, use PATH java exclusively
    BEST_JAVA="$PATH_JAVA"
    BEST_VERSION="$PATH_VERSION"
    debug "Strict mode: using java from PATH: $BEST_JAVA (version $BEST_VERSION)"
else
    # Normal mode: use first valid Java found (fast path optimization)
    check_java() {
        java_exe="$1"
        source="$2"

        if [ ! -x "$java_exe" ]; then
            return 1
        fi

        version=$(get_java_version "$java_exe")

        if is_valid_version "$version"; then
            debug "Found valid Java $version at $java_exe (from $source)"
            BEST_JAVA="$java_exe"
            BEST_VERSION="$version"
            return 0
        else
            debug "Skipping $java_exe (version $version, from $source)"
            return 1
        fi
    }

    # 1. Try JAVA_HOME
    if [ -n "$JAVA_HOME" ] && check_java "$JAVA_HOME/bin/java" "JAVA_HOME"; then
        : # Found valid Java, will execute below
    # 2. Try PATH
    elif command -v java >/dev/null 2>&1 && check_java "$(command -v java)" "PATH"; then
        : # Found valid Java, will execute below
    # 3. Try /etc/alternatives/java
    elif check_java "/etc/alternatives/java" "/etc/alternatives"; then
        : # Found valid Java, will execute below
    else
        # 4. Try common JVM directories as last resort
        if [ "$(uname -s)" = "Darwin" ]; then
            JVM_DIR="/Library/Java/JavaVirtualMachines"
            CONTENTS_HOME="/Contents/Home"
        else
            JVM_DIR="/usr/lib/jvm"
            CONTENTS_HOME=""
        fi

        if [ -d "$JVM_DIR" ]; then
            for JVM in "$JVM_DIR"/*; do
                if [ -d "$JVM" ]; then
                    if check_java "$JVM$CONTENTS_HOME/bin/java" "common JVM dir"; then
                        break
                    fi
                fi
            done
        fi
    fi
fi

# Use BEST_JAVA if found
if [ -n "$BEST_JAVA" ]; then
    debug "Selected Java: $BEST_JAVA"
    debug "Java version: $BEST_VERSION"
    debug "JVM options: {{#if jvmOpts}}{{{jvmOpts}}} {{/if}}$USER_JAVA_OPTS"
    debug "Executing: $BEST_JAVA {{#if jvmOpts}}{{{jvmOpts}}} {{/if}}$USER_JAVA_OPTS -jar $0 $*"

    # shellcheck disable=SC2086
    exec "$BEST_JAVA" {{#if jvmOpts}}{{{jvmOpts}}} {{/if}}$USER_JAVA_OPTS -Dsun.misc.URLClassPath.disableJarChecking {{#if hasJavaProperties}}{{#each javaProperties}}-D{{{@key}}}="{{{this}}}" {{/each}}{{/if}}-jar "$0" {{#if hasPrependArgs}}{{{prependArgs}}} {{/if}}"$@"{{#if hasAppendArgs}} {{{appendArgs}}}{{/if}}
fi

# No valid Java found
echo "Error: No compatible JDK found for {{{artifactName}}}" >&2
echo "" >&2
echo "Requirements:" >&2
echo "  - Java version >= $MIN_JAVA_VERSION" >&2
if [ -n "$MAX_JAVA_VERSION" ]; then
    echo "  - Java version <= $MAX_JAVA_VERSION" >&2
fi
echo "" >&2
echo "Please install a compatible JDK or set JAVA_HOME to point to one." >&2
echo "" >&2
echo "Tip: Set EXECJAR_DEBUG=1 to see which Java installations were checked." >&2
exit 1